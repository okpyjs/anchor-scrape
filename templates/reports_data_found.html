<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Reports Data Found</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>

<body>
    <div class="container">
        <div class="row mt-5">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <h1 class="text-center mb-4">Internal Links and Anchor Text Counter</h1>
                <div class="text-center mb-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="lead mt-3">Crawling in progress...</p>
                </div>
                <div class="d-none" id="results-section">
                    <div class="row">
                        <!-- <div class="col-md-2"></div> -->
                        <div class="col-md-12 text-center">
                            <!-- <h2>Anchor Text Distribution</h2> -->
                            <canvas id="chart"></canvas>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <h2 class="mb-4">Links to URL</h2>
                            <p><strong>Total Links:</strong> <span id="total-links"></span></p>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Anchor Text</th>
                                    </tr>
                                </thead>
                                <tbody id="links-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.1/dist/umd/popper-base.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.6.0/dist/chart.min.js"></script>

    <script>
        function getRandomColor() {
            const r = Math.floor(Math.random() * 256); // generate a random value for the red component (0-255)
            const g = Math.floor(Math.random() * 256); // generate a random value for the green component (0-255)
            const b = Math.floor(Math.random() * 256); // generate a random value for the blue component (0-255)
            return `rgb(${r}, ${g}, ${b})`; // return the color as an RGB string
        }

        var urlParams = new URLSearchParams(window.location.search);
        var url = decodeURIComponent(urlParams.get('url'));

        // data = {
        //     "total_links": 42,
        //     "anchor_text_distribution": {
        //         "Click here": 8,
        //         "Learn more": 6,
        //         "Read more": 5,
        //         "Contact us": 4,
        //         "About us": 3,
        //         "Products": 2,
        //         "Services": 2,
        //         "FAQ": 1,
        //         "Testimonials": 1,
        //         "Other": 10
        //     },
        //     "links": [
        //         {
        //             "url": "https://example.com/page1.html",
        //             "anchor_text": "Click here"
        //         },
        //         {
        //             "url": "https://example.com/page2.html",
        //             "anchor_text": "Learn more"
        //         },
        //         {
        //             "url": "https://example.com/page3.html",
        //             "anchor_text": "Read more"
        //         },
        //         {
        //             "url": "https://example.com/contact.html",
        //             "anchor_text": "Contact us"
        //         },
        //         {
        //             "url": "https://example.com/about.html",
        //             "anchor_text": "About us"
        //         },
        //         {
        //             "url": "https://example.com/products.html",
        //             "anchor_text": "Products"
        //         },
        //         {
        //             "url": "https://example.com/services.html",
        //             "anchor_text": "Services"
        //         },
        //         {
        //             "url": "https://example.com/faq.html",
        //             "anchor_text": "FAQ"
        //         },
        //         {
        //             "url": "https://example.com/testimonials.html",
        //             "anchor_text": "Testimonials"
        //         },
        //         {
        //             "url": "https://example.com/page4.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page5.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page6.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page7.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page8.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page9.html",
        //             "anchor_text": "Other"
        //         },
        //         {
        //             "url": "https://example.com/page10.html",
        //             "anchor_text": "Other"
        //         }
        //     ]
        // }
        let data = JSON.parse('{{data | tojson}}')
        console.log(data.anchor_text_distribution)
        const sortedObj = Object.fromEntries(Object.entries(data.anchor_text_distribution).sort((a, b) => b[1] - a[1]));
        $('.fa-spinner').addClass('d-none');
        $('.lead').addClass('d-none');
        $('#results-section').removeClass('d-none');
        $('#total-links').text(data.total_links);

        chartBgColor = []
        chartBorderColor = []
        for(i = 0; i < 10; i ++) {
            chartBgColor.push(getRandomColor())
            chartBorderColor.push(getRandomColor())
        }


        var chartData = {
            labels: [],
            datasets: [{
                // label: 'Anchor Text Distribution',
                data: [],
                backgroundColor: chartBgColor,
                borderColor: chartBorderColor,
                borderColor: 'white',
                borderWidth: 2,
                hoverOffset: 8,
            }]
        };
        var labels = Object.keys(sortedObj);
        var dataValues = Object.values(sortedObj);
        var otherValue = 0;
        for (var i = 0; i < labels.length; i++) {
            if (i < 9) {
                chartData.labels.push(labels[i]);
                chartData.datasets[0].data.push(dataValues[i]);
            } else {
                otherValue += dataValues[i];
            }
        }
        if (otherValue > 0) {
            chartData.labels.push('Other');
            chartData.datasets[0].data.push(otherValue);
        }

        // var myChart = new Chart(
        //     document.getElementById('chart'),
        //     config
        // );
        // var chartCtx = document.getElementById('chart').getContext('2d');
        // var chart = new Chart(chartCtx, {
        //     type: 'pie',
        //     data: chartData
        // });
        const options = {
            responsive: true,
            aspectRatio: 0.7,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 18,
                            weight: 'bold'
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Anchor Text Distribution',
                    font: {
                        size: 24,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return `${context.label}: ${context.formattedValue}`;
                        }
                    }
                }
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0,
                },
                position: {
                    top: 30
                }
            },
            cutout: '0%',
            // rotation: 0.5 * Math.PI,
            // circumference: 1.5 * Math.PI,
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            onClick: function (event, elements) {
                console.log(event);
                console.log(elements);
            }
        };

        const config = {
            type: 'pie',
            data: chartData,
            options: options
        };

        var myChart = new Chart(
            document.getElementById('chart'),
            config
        );


        var linksTableBody = '';
        data.links.forEach(function (link) {
            linksTableBody += '<tr><td><a href="' + link.url + '">' + link.url + '</a></td><td>' + link.anchor_text + '</td></tr>';
        });
        $('#links-table-body').html(linksTableBody);

    </script>
</body>

</html>
